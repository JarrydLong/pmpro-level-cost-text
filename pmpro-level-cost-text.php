<?php
/*
Plugin Name: PMPro Custom Level Cost Test
Plugin URI: http://www.paidmembershipspro.com/wp/pmpro-custom-level-cost-text/
Description: Manually override the level cost text for each level or discount code.
Version: .1
Author: Stranger Studios
Author URI: http://www.strangerstudios.com
*/

//Set up settings
function cost_format_settings() {
    $custom_fields = array(
        'pmpro_hide_now' => array(
            'field_name' => 'pmpro_hide_now',
            'field_type' => 'select',
            'label' => 'Remove the word "now" from level cost text.',
            'options' => array(0 => 'No', 1 => 'Yes'),
        ),
        'pmpro_use_free' => array(
            'field_name' => 'pmpro_use_free',
            'field_type' => 'select',
            'label' => 'Use the word "Free" instead of $0.00',
            'options' => array(0 => 'No', 1 => 'Yes'),
        ),
        'pmpro_use_slash' => array(
            'field_name' => 'pmpro_use_slash',
            'field_type' => 'select',
            'label' => 'Use "/" instead of "per"',
            'options' => array(0 => 'No', 1 => 'Yes'),
        ),
        'pmpro_hide_decimals' => array(
            'field_name' => 'pmpro_hide_decimals',
            'field_type' => 'select',
            'label' => 'Hide unnecessary decimals',
            'options' => array(0 => 'No', 1 => 'Yes'),
        ),
        'pmpro_abbreviate_time' => array(
            'field_name' => 'pmpro_abbreviate_time',
            'field_type' => 'select',
            'label' => 'Abbreviate "Month", "Week", and "Year" to "Mo", "Wk", and "Yr"',
            'options' => array(0 => 'No', 1 => 'Yes'),
        )
    );

    return $custom_fields;
}
add_filter('pmpro_custom_advanced_settings','cost_format_settings');

function format_cost($cost) {
	if(pmpro_getOption('pmpro_hide_now') == 'Yes'){
		$cost = str_replace(" now", "", $cost);
		
	}
	if(pmpro_getOption('pmpro_use_free') == 'Yes'){
		global $pmpro_currency_symbol;
		$cost = str_replace($pmpro_currency_symbol.'0.00', 'free', $cost);
		$cost = str_replace('0.00'.$pmpro_currency_symbol, 'free', $cost);
		$cost = str_replace($pmpro_currency_symbol.'0,00', 'free', $cost);
		$cost = str_replace('0,00'.$pmpro_currency_symbol, 'free', $cost);
	}
	if(pmpro_getOption('pmpro_use_slash') == 'Yes'){
		$cost = str_replace(" per ", "/", $cost);
	}
	if(pmpro_getOption('pmpro_hide_decimals') == 'Yes'){
		$cost = str_replace(".00", "", $cost);
		$cost = str_replace(",00", "", $cost);
	}
	if(pmpro_getOption('pmpro_abbreviate_time') == 'Yes'){
		$cost = str_replace("Year", "Yr", $cost);
		$cost = str_replace("Wk", "Wk", $cost);
		$cost = str_replace("Month", "Mo", $cost);
	}
	return $cost;
}

/*
	This first set of functions adds a level cost text field to the edit membership levels page
*/
//add level cost text field to level price settings
function pclct_pmpro_membership_level_after_other_settings()
{
	$level_id = intval($_REQUEST['edit']);
	if($level_id > 0)
		$level_cost_text = pmpro_getCustomLevelCostText($level_id);	
	else
		$level_cost_text = "";
?>
<h3 class="topborder">Custom Level Cost Text</h3>
<p>To override the default level cost text generated by Paid Memberships Pro. Make sure the prices in this text match your settings above.</p>
<table>
<tbody class="form-table">
	<tr>
		<td>
			<tr>
				<th scope="row" valign="top"><label for="level_cost_text">Level Cost Text:</label></th>
				<td>
					<textarea name="level_cost_text" rows="4" cols="50"><?php echo esc_textarea($level_cost_text);?></textarea>
					<br /><small>If completely blank, the default text generated by PMPro will be used. You can modify the format of the default text in <a href="../wp-admin/admin.php?page=pmpro-advancedsettings">Advanced Settings.</a></small>
				</td>
			</tr>
		</td>
	</tr> 
<tr>
<th scope="row" valign="top"><label for="level_cost_text"><label for="variable_references">Variable Reference:</label></th>
<td>
<div id="template_reference" style="overflow:scroll;height:250px;width:800px;;">
				<table class="widefat striped">
					<tr>
						<th colspan=2><?php _e('General Settings / Membership Info To Be Used In Level Cost Text:', 'pmproet');?></th>
					</tr>
					<tr>
						<td>!!name!!</td>
						<td><?php _e('Display Name (Profile/Edit User > Display name publicly as)', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!user_login!!</td>
						<td><?php _e('Username', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!sitename!!</td>
						<td><?php _e('Site Title', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!siteemail!!</td>
						<td><?php _e('Site Email Address (General Settings > Email OR Memberships > Email Settings)', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!membership_id!!</td>
						<td><?php _e('Membership Level ID', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!membership_level_name!!</td>
						<td><?php _e('Membership Level Name', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!membership_change!!</td>
						<td><?php _e('Membership Level Change', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!membership_expiration!!</td>
						<td><?php _e('Membership Level Expiration', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!display_name!!</td>
						<td><?php _e('Display Name (Profile/Edit User > Display name publicly as)', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!enddate!!</td>
						<td><?php _e('User Subscription End Date', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!user_email!!</td>
						<td><?php _e('User Email', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!login_link!!</td>
						<td><?php _e('Login URL', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!levels_link!!</td>
						<td><?php _e('Membership Levels Page URL', 'pmproet');?></td>
					</tr>
					<tr>
						<th colspan=2>Billing Information</th>
					</tr>
					<tr>
						<td>!!billing_address!!</td>
						<td><?php _e('Billing Info Complete Address', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!billing_name!!</td>
						<td><?php _e('Billing Info Name', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!billing_street!!</td>
						<td><?php _e('Billing Info Street Address', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!billing_city!!</td>
						<td><?php _e('Billing Info City', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!billing_state!!</td>
						<td><?php _e('Billing Info State', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!billing_zip!!</td>
						<td><?php _e('Billing Info ZIP Code', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!billing_country!!</td>
						<td><?php _e('Billing Info Country', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!billing_phone!!</td>
						<td><?php _e('Billing Info Phone #', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!cardtype!!</td>
						<td><?php _e('Credit Card Type', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!accountnumber!!</td>
						<td><?php _e('Credit Card Number (last 4 digits)', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!expirationmonth!!</td>
						<td><?php _e('Credit Card Expiration Month (mm format)', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!expirationyear!!</td>
						<td><?php _e('Credit Card Expiration Year (yyyy format)', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!membership_cost!!</td>
						<td><?php _e('Membership Level Cost Text', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!instructions!!</td>
						<td><?php _e('Payment Instructions (used in Checkout - Email Template)', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!invoice_id!!</td>
						<td><?php _e('Invoice ID', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!invoice_total!!</td>
						<td><?php _e('Invoice Total', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!invoice_date!!</td>
						<td><?php _e('Invoice Date', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!discount_code!!</td>
						<td><?php _e('Discount Code Applied', 'pmproet');?></td>
					</tr>
					<tr>
						<td>!!invoice_link!!</td>
						<td><?php _e('Invoice Page URL', 'pmproet');?></td>
					</tr>
				</table>
			</div>
</td>
</tr>
</tbody>
</table>
<?php
}
add_action("pmpro_membership_level_after_other_settings", "pclct_pmpro_membership_level_after_other_settings");

//save level cost text when the level is saved/added
function pclct_pmpro_save_membership_level($level_id)
{
	pmpro_saveCustomLevelCostText($level_id, $_REQUEST['level_cost_text']);			//add level cost text for this level			
}
add_action("pmpro_save_membership_level", "pclct_pmpro_save_membership_level");

//update subscription start date based on the discount code used
function pclct_pmpro_level_cost_text_levels($cost, $level)
{
	global $wpdb;
		
	$custom_text = pmpro_getCustomLevelCostText($level->id);		
	if(!empty($custom_text))
	{				
		$cost = $custom_text;
	}
	else{
		$cost = format_cost($cost);
	}
	
	return $cost;
}
add_filter("pmpro_level_cost_text", "pclct_pmpro_level_cost_text_levels", 15, 2);		//priority 15, so discount code text will override this

/*	
	This function will save a level_cost_text for a discount code into an array stored in pmpro_code_level_cost_text.
*/
function pmpro_saveCustomLevelCostText($level_id, $level_cost_text)
{	
	$all_level_cost_text = get_option("pmpro_level_cost_text", array());
		
	$all_level_cost_text[$level_id] = $level_cost_text;
	
	update_option("pmpro_level_cost_text", $all_level_cost_text);
}

/*
	This function will return the level cost text for a discount code/level combo
*/
function pmpro_getCustomLevelCostText($level_id)
{
	$all_level_cost_text = get_option("pmpro_level_cost_text", array());
	
	if(!empty($all_level_cost_text[$level_id]))
	{
		return $all_level_cost_text[$level_id];
	}
	
	//didn't find it
	return "";
}


/*
	This next set of functions adds the level cost text field to the edit discount code page
*/
//add level cost text field to level price settings
function pclct_pmpro_discount_code_after_level_settings($code_id, $level)
{
	$level_cost_text = pmpro_getCodeCustomLevelCostText($code_id, $level->id);	
?>
<table>
<tbody class="form-table">
	<tr>
		<td>
			<tr>
				<th scope="row" valign="top"><label for="level_cost_text">Level Cost Text:</label></th>
				<td>
					<textarea name="level_cost_text[]" rows="4" cols="50"><?php echo esc_textarea($level_cost_text);?></textarea>
					<br /><small>If completely blank, the default text generated by PMPro will be used.</small>
				</td>
			</tr>
		</td>
	</tr> 
</tbody>
</table>
<?php
}
add_action("pmpro_discount_code_after_level_settings", "pclct_pmpro_discount_code_after_level_settings", 10, 2);

//save level cost text for the code when the code is saved/added
function pclct_pmpro_save_discount_code_level($code_id, $level_id)
{
	$all_levels_a = $_REQUEST['all_levels'];							//array of level ids checked for this code
	$level_cost_text_a = $_REQUEST['level_cost_text'];			//level_cost_text for levels checked
		
	if(!empty($all_levels_a))
	{	
		$key = array_search($level_id, $all_levels_a);				//which level is it in the list?				
		pmpro_saveCodeCustomLevelCostText($code_id, $level_id, $level_cost_text_a[$key]);			//add level cost text for this level		
	}	
}
add_action("pmpro_save_discount_code_level", "pclct_pmpro_save_discount_code_level", 10, 2);

//update level cost text based on the discount code used
function pclct_pmpro_level_cost_text_code($cost, $level)
{
	global $wpdb;
		
	//check if a discount code is being used
	if(!empty($level->code_id))
		$code_id = $level->code_id;
	elseif(!empty($_REQUEST['discount_code']))
		$code_id = $wpdb->get_var("SELECT id FROM $wpdb->pmpro_discount_codes WHERE code = '" . $wpdb->escape($_REQUEST['discount_code']) . "' LIMIT 1");
	else
		$code_id = false;
	
	//used?
	if(!empty($code_id))
	{				
		//we have a code						
		$level_cost_text = pmpro_getCodeCustomLevelCostText($code_id, $level->id);		
		
		if(!empty($level_cost_text))
		{
			$cost = $level_cost_text;
			return $cost;
		}		
	}
	
	return $cost;
}
add_filter("pmpro_level_cost_text", "pclct_pmpro_level_cost_text_code", 20, 2);

/*	
	This function will save a level_cost_text for a discount code into an array stored in pmpro_code_level_cost_text.
*/
function pmpro_saveCodeCustomLevelCostText($code_id, $level_id, $level_cost_text)
{	
	$all_level_cost_text = get_option("pmpro_code_level_cost_text", array());
	
	//make sure we have an array for the code
	if(empty($all_level_cost_text[$code_id]))
		$all_level_cost_text[$code_id] = array();
	
	$all_level_cost_text[$code_id][$level_id] = $level_cost_text;
	
	update_option("pmpro_code_level_cost_text", $all_level_cost_text);
}

/*
	This function will return the level cost text for a discount code/level combo
*/
function pmpro_getCodeCustomLevelCostText($code_id, $level_id)
{
	$all_level_cost_text = get_option("pmpro_code_level_cost_text", array());
	
	if(!empty($all_level_cost_text[$code_id]))
	{
		if(!empty($all_level_cost_text[$code_id][$level_id]))
			return $all_level_cost_text[$code_id][$level_id];
	}
	
	//didn't find it
	return "";
}
